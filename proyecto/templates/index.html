<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard - PostgreSQL (ACA2)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Highcharts -->
  <script src="https://code.highcharts.com/highcharts.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; padding: 20px; }
    h1 { text-align: center; margin: 10px 0 20px; }

    .container { max-width: 1100px; margin: 0 auto; }

    .card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 18px;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 18px;
    }
    .kpi {
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-align: center;
    }
    .kpi b { display:block; font-size: 12px; color:#000000; letter-spacing: .4px; }
    .kpi .val { font-size: 16px; margin-top: 4px; font-weight: 700; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 18px;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 13px; }
    th { background: #f0f0f0; }

    canvas { max-height: 320px; width: 100% !important; }

    .filtros-row {
      display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap;
    }
    .filtro {
      display:flex; flex-direction:column; gap:6px;
      min-width: 240px;
    }
    label { font-size: 13px; color:#333; }
    select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #d6d6d6;
      background: white;
    }
    .btn {
      padding: 9px 14px;
      border-radius: 8px;
      border: 0;
      cursor:pointer;
      font-weight: 700;
    }
    .btn-primary { background:#111827; color:white; }
    .btn-link { background:transparent; color:#060afc; text-decoration: underline; padding: 9px 0; }

    /* ✅ Tamaño controlado para Highcharts */
    .hc-container{
      width: 100%;
      height: 320px;   /* ajusta aquí si lo quieres más alto */
    }

    /* Responsive */
    @media (max-width: 900px){
      .kpis{ grid-template-columns: 1fr 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Dashboard - PostgreSQL (ACA2)</h1>

    <!-- =========================
         FILTRO GLOBAL (CIUDAD + CATEGORIA)
         ========================= -->
    <div class="card">
      <h3 style="margin-top:0;">Filtro global</h3>

      <form method="get" class="filtros-row">
        <div class="filtro">
          <label for="ciudad">Filtrar por ciudad:</label>
          <select name="ciudad" id="ciudad">
            <option value="">Todas</option>
            {% for c in ciudades_disponibles %}
              <option value="{{ c }}" {% if c == ciudad_seleccionada %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filtro">
          <label for="categoria">Filtrar productos por categoría:</label>
          <select name="categoria" id="categoria">
            <option value="">(Todas)</option>
            {% for cat in categorias_disponibles %}
              <option value="{{ cat }}" {% if cat == categoria_seleccionada %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </div>

        <button class="btn btn-primary" type="submit">Aplicar</button>
        <a class="btn btn-link" href="/">Quitar filtro</a>
      </form>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi"><b>TOTAL CLIENTES</b><div class="val">{{ total_clientes }}</div></div>
      <div class="kpi"><b>TOTAL PEDIDOS</b><div class="val">{{ total_pedidos }}</div></div>
      <div class="kpi"><b>SUMA SUBTOTAL</b><div class="val">{{ suma_subtotal }}</div></div>
      <div class="kpi"><b>SUMA ENVÍO</b><div class="val">{{ suma_envio }}</div></div>
    </div>

    <!-- Gráficos (2 arriba) -->
    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0;">Clientes por ciudad</h3>
        <canvas id="clientesCiudadChart"></canvas>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Pedidos por estado</h3>
        <canvas id="pedidosEstadoChart"></canvas>
      </div>
    </div>

    <!-- Productos por categoría -->
    <div class="card">
      <h3 style="margin-top:0;">Productos por categoría</h3>
      <canvas id="productosCategoriaChart"></canvas>
    </div>

    <!-- Pagos por método (Chart.js) -->
    <div class="card">
      <h3 style="margin-top:0;">Pagos por método (Chart.js)</h3>
      <canvas id="pagosMetodoChart"></canvas>
    </div>

    <!-- ✅ Pagos por método (Highcharts) -->
    <div class="card">
      <h3 style="margin-top:0;">Pagos por método (Highcharts)</h3>
      <div id="pagosMetodoHighcharts" class="hc-container"></div>
    </div>

    <!-- Tabla clientes -->
    <div class="card">
      <h3 style="margin-top:0;">Clientes (muestra)</h3>
      <table>
        <tr>
          <th>ID</th><th>Nombre</th><th>Correo</th><th>Ciudad</th><th>Edad</th>
        </tr>
        {% for c in clientes %}
        <tr>
          <td>{{ c.cliente_id }}</td>
          <td>{{ c.nombre_completo }}</td>
          <td>{{ c.correo }}</td>
          <td>{{ c.ciudad }}</td>
          <td>{{ c.edad }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <!-- Tabla pedidos -->
    <div class="card">
      <h3 style="margin-top:0;">Pedidos (muestra)</h3>
      <table>
        <tr>
          <th>Cliente</th><th>Fecha</th><th>Estado</th><th>Subtotal</th><th>Envío</th>
        </tr>
        {% for p in pedidos %}
        <tr>
          <td>{{ p.cliente_id }}</td>
          <td>{{ p.fecha_pedido }}</td>
          <td>{{ p.estado }}</td>
          <td>{{ p.subtotal }}</td>
          <td>{{ p.costo_envio }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <!-- Tabla pagos muestra -->
    <div class="card">
      <h3 style="margin-top:0;">Pagos (muestra)</h3>
      <table>
        <tr>
          <th>Pago</th><th>Pedido</th><th>Método</th>
        </tr>
        {% for x in pagos %}
        <tr>
          <td>{{ x.pago_id }}</td>
          <td>{{ x.pedido_id }}</td>
          <td>{{ x.metodo_pago }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

  </div>

  <script>
    // =========================
    // 1) Clientes por ciudad (bar)
    // =========================
    const ciudades = [{% for c in clientes_por_ciudad %}"{{ c.ciudad }}",{% endfor %}];
    const totalesCiudad = [{% for c in clientes_por_ciudad %}{{ c.total }},{% endfor %}];

    new Chart(document.getElementById("clientesCiudadChart"), {
      type: "bar",
      data: {
        labels: ciudades,
        datasets: [{
          label: "Clientes",
          data: totalesCiudad
        }]
      },
      options: { responsive: true }
    });

    // =========================
    // 2) Pedidos por estado (pie)
    // =========================
    const estados = [{% for p in pedidos_por_estado %}"{{ p.estado }}",{% endfor %}];
    const totalesEstado = [{% for p in pedidos_por_estado %}{{ p.total }},{% endfor %}];

    new Chart(document.getElementById("pedidosEstadoChart"), {
      type: "pie",
      data: {
        labels: estados,
        datasets: [{
          data: totalesEstado
        }]
      },
      options: { responsive: true }
    });

    // =========================
    // 3) Productos por categoría (bar)
    // =========================
    const categorias = [{% for p in productos_por_categoria %}"{{ p.categoria }}",{% endfor %}];
    const totalesProductos = [{% for p in productos_por_categoria %}{{ p.total }},{% endfor %}];

    new Chart(document.getElementById("productosCategoriaChart"), {
      type: "bar",
      data: {
        labels: categorias,
        datasets: [{
          label: "Productos por categoría",
          data: totalesProductos
        }]
      },
      options: { responsive: true }
    });

    // =========================
    // 4) Pagos por método (Chart.js - doughnut)
    // =========================
    const metodos = [{% for m in pagos_por_metodo %}"{{ m.metodo_pago }}",{% endfor %}];
    const totalesMetodo = [{% for m in pagos_por_metodo %}{{ m.total }},{% endfor %}];

    new Chart(document.getElementById("pagosMetodoChart"), {
      type: "doughnut",
      data: {
        labels: metodos,
        datasets: [{
          label: "Pagos por método",
          data: totalesMetodo
        }]
      },
      options: { responsive: true }
    });

    // =========================
    // 5) Pagos por método (Highcharts)
    // =========================
    const pagosSeries = [
      {% for m in pagos_por_metodo %}
        { name: "{{ m.metodo_pago }}", y: {{ m.total }} },
      {% endfor %}
    ];

    Highcharts.chart("pagosMetodoHighcharts", {
      chart: { type: "column" },
      title: { text: "" },
      xAxis: { type: "category", title: { text: "Método" } },
      yAxis: { title: { text: "Cantidad de pagos" } },
      tooltip: { pointFormat: "<b>{point.y}</b> pagos" },
      series: [{
        name: "Pagos",
        data: pagosSeries
      }],
      credits: { enabled: false }
    });
  </script>

</body>
</html>








